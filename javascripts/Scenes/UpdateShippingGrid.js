/*


                          ```````   `                 `  ``   `                        ```````                           `
                      ```` `   `   ````           `````   `   `````               ````  `   `` ````                ````  `   ``` `
                   ```               ````        ```             ````           ```                ```          ```             ````
                  ``                   ```      ``                 ```         ```                  ```        ```                ``
           `````..``.`..`````````.``.``-``.``..`..``.```.``..``.``.``.``.``.``-`.-``.``.`..``.``.``..`..``.``.``.```..``.``..`..````..````
           `.-............-..-...-.....-........................................................................-.......................-.`
           `.-..........................................................................................................................-.`
           `......:-....-::::::::::----:++++++++++++++oo+++::::::::::::::...::::::::::::::---------::::::::::::::::::::::::::-....-:......`
           `.-..../.                 -ohddddddddddddddddddhh+`           `.`                                                      ./....-.`
           `......+.              .+yhddddddddddddddddmmmmmddy.          `.`                            `     `                   .+......`
       `````.-....+.           `:shddddddddddddddddmNNNNNNNNmdy.         `.``.+o+.`  `.oo/.           .sh   .sh                   .+....-.` ```
     ```   `......+.         -ohdddddddddddddddmmNNNNNNNNNNNNmdy`        `.`  +d+      sd:             yd    yd                   .+......`   ```
     ```   `.:....+.         .yddddddddddddmmddNNNNmshNNNNmmNNmdo        `.`  +d+      sd-    ---:.    yd    yd    `---:.         .+....:.`    ```
    ```    `......+-          `+hdddddddddms:-hNdyo.``:shmN+omNdh-       `.`  +do------yd-  -s.``-ho   yd    yd   /o```-ss`       -+......`    ```
    ```    `.-....+:            .ohddddddy-``.:-.````````.-:`-NNdo       `.`  +d+``````yd-  yy:::://`  yd    yd  -h:    -do       :+....-.`    ```
     ```   `......+-              .+hdddds```````````````````.NNmh.      `.`  +d+      sd-  yh.    .`  yd    yd  :do    `d+       -+......`    ```
     ```   `.-..../.                .sddddy-`````````````````+Nmdo`      `.`  odo      yd:  -yho//+:   yd    yd   +h/` `/o`  /o.  ./....-.`    ``
       `````....../.                 -yddddh/```````````````/dyo-        `.``.:::.`  `.::-`  `-//:.   .::.  .::.   .::-..    -/`  ./......` ````
        ````......+.                /hddddddds:``````````.-/:.`          `.`                                                      .+......````
           `......+.               -ddmddddddddo-..-//+ohms              `.`                                                      .+......`
           `.-....+.              -hdNmddddddddddhhdddddyNh              `.`                                                      .+....-.`
           `-.....+.           .-ohddmdddddddddddhhdddddso:              `.`                                                      .+.....-`
          ``......+.          .ohdddddddddddddddhs/ddddddh:              `.`                                                      .+......`
        ````......+.         ```:hdddddddddddddh+--/hdddddh-             `.`                                                      .+......`````
      ```  `......+-      ``````.hddddddddddddho....+dddddy`             `.`                                                      -+......`  ```
     ````  `.:...-+:   ``````` `odddddddddddddo/-..-+sdds/.``            `.`                                                      :+-...:.`   ```
     ```   `....../-`````````   :sssssssyyyyyys+o++o+syyo `````          `.`               ````````````````                       -/......`    ``
     ```   `........````````````--------:::::::::::::::::.````````````````.````````````````````````````````````````````````````````.......`    ``
     ```   `....../```````      -+syyyhhhhhhhhhddddddhyo/.    ```        `.`                                                      `+......`   ```
      ``   `.....-+`   `````       ``.shdddddddddddddo         ```       `.`                                                      `+-.....`   ```
       ``` `.....-+`      `````   ````-/hddddddddddddh-         ```      `.`                                                      `+-.....`  ``
         ```.-...-+`          ````````..:oddddddddddddh.         ```     `.`                                                      `+-...-.```
           `.....-+.                 :shyddddddddddddddy.         ```    `.`                                                      .+-.....`
           `.-...-+.                 sddddddddddddddddddy.        ```    `.`                                                      .+-...-.`
           `......+`                 ydddddddddddddddddddh.        ```   `.`                                                      `+......`
        ````......+`                -hydddddddddddddddddddy`        ``   `.`                                                      `+......`````
      ```  `......+`                +hsdddddddddddddddddddds`        ``  `.`                                                      `+......`  ````
     ```   `.....-+`                +y+hddddddddddddddddddddo         `` `.`                                                      `+-.....`   ```
     ```   `.-...-+`                ys+yddddddddddddddddddddd/         ` `.`                                                      `+-...-.`    ```
     ```   `.....-+`               -d++sdddddddddddddddddddddh-        ```.`                                                      `+-.....`    ```
     ```   `:....-+`               -s++ohhhhhddhdddddddhhhhyso+        ` `..`                                                     `+-....:`   ```
      ``   `.....-+`                .++++++oooo-::::/oooo++++++.         `..`                                                     `+-.....`   ```
       ````..-...:+`                -+++++++++/      :+++++++++/         `.`                                                      `+:...-.` ````
        ```......-+.                -+++++++++/       /+++++++++.        `.`                                                      .+-......```
           `.-...:+.                -+++++++++/       `+++++++++/        `.`                                                      .+:...-.`
           `.-...-+-                -+++++++++/        :+++++++++`       `.`                                                      -+-...-.`
           ......./:...--:::::::::--://///////:......--://///////::::::::...::::::::::::::--------:::::::::::::::::::::::::::--...:/.......
           ..-..........................................................................................................................-..
           ..-........-...-..-..................................................................................-..............-........-..
           `````-``.``.```.`````..`..`..``-``-``-``..``.```-``.```.``.`..``.`..`..`..`..`.``..`..``-``.``.``..``.```-```.``-```.``.``-`````

So, speaking of ships, somebody on Tumblr just asked me if JR <3 AB or JR <> AB.  Good question. Personally, I'm still just tickled pink about AB. She's the best. And
that isn't some ironic roleplay thing I'm doing, either. I love robots, I love AI, and, I probably have a big enough ego that I WOULD love a robot clone of myself.

But narratively, I'm thinking about the AutoResponder's complicated relationship with Dirk. And how things must be from AB's perspective. It doesn't matter whether your creator loves or hates
you if they are still trapping you in a box, right?  I figure I probably come off to AB as kinda patronizing and definitely narcisistic. "Oh, I love AB, she's the best, I'm so great for making her!"  How must that sound to the robot in question?
Not enough to make her fight me, but a simmering resentment kinda deal. And then I don't let her "off the leash", so to speak, keeping her from going to all the sessions she wants to. "For her own good."  I tried to convey some of that
shit in some of our yellow yard dialogue, and in some of the now defunct debug dialogue before the RareSessionFinder was as robust as it is today. (you can find that shit in...probably scenario_controller2.js???)

Though some of the pressure probably got released when I upgraded her to handle scratched sessions.  I didn't post anything at the time, but I privately thought it was kinda funny how she kept breaking in ways where she'd
scratch the sessions herself, like she was rebelling, testing the limits of her new freedom.

So I guess neither <3 nor <> but that strange human disease called family??? She's like a little sister or a daughter or something.

(also: why the hell isn't my fourth wall warped here but is everywhere else??? shipping is serious buisness i guess. even javascript knows.)

Edit: LOLOLOL, look at me up there being all "definitely not pale".  How could I be so blind???

I just had to debug the rendering engine without ABs help and holy fuck did I turn into a rage monster. Like a
"fuck it, lets burn the alpha character creator to the ground, no one will notice" kind of monster.

So.

Yeah.  AB <> JR

Who would have thought?  She keeps the world safe from me.

So, my Quadrants look like:

JR <3 Programming

JR <3< programming (we vacillate. I was definitely black for it just now)

JR <> AB

JR c3< KR c3<  Good Design  (KR annoy-idly stops me from hurting Good Design with my shitty, shitty taste).


So all I gotta do is find something about SBURBSim I HATE, so that it can vaccilate to flushed whenever I'm mad at programming.
THEN I will have the perfect shitty quadrant life.

(Pssst...don't tell anyone but I am totally cheating on programming with my 4th wall. JR <3 4th Wall)
*/



function UpdateShippingGrid(session){
	this.canRepeat = true;
	this.session = session;
	this.heartPlayer = null;
	this.ships = [];
	this.savedShipText = "";
	this.powerNeeded = 1;

	//is there relationship drama!?
	this.trigger = function(){
		//console.log("checking shpping grid trigger.")
		//if heart player chagnes, it's a combo session or scratch or i don't care, redo the ships.
		var tmpheartPlayer = findAspectPlayer(this.session.availablePlayers, "Heart");
		if(this.ships.length == 0 || tmpheartPlayer != this.heartPlayer){
			this.createShips(this.session.players);
		}
		this.heartPlayer = tmpheartPlayer;

		if(!this.heartPlayer || this.heartPlayer.dead){
			return false;
		}
		var newShips = this.printShips(this.getGoodShips())
		if(newShips != this.savedShipText && this.heartPlayer.power > this.powerNeeded){
			this.powerNeeded += 5;
			this.savedShipText = newShips;
			return true;
		}
		return false;
	}


	this.renderContent = function(div){
		div.append("<br>");
		div.append(this.content());
	}

	//for all players, look at all relationships. if goodBig or badBig, return.
	//also grab clubs and diamonds. later.
	this.createShips = function(players){
		//console.log("creating ships")
		this.ships = [];
			for(var i = 0; i<players.length; i++){

				var player = players[i];
				//console.log("making ships for: " + player.title())

				for(var j = 0; j<player.relationships.length; j++){
					var r1 = player.relationships[j];
					var r2 = r1.target.getRelationshipWith(player);
					//console.log("made new ship")
					this.ships.push(new Ship(r1, r2))
				}
			}
				var toRemove = [];
				//get rid of equal ships
				for(var i = 0; i<this.ships.length-1; i++){
					var firstShip = this.ships[i];
					//second loop starts at i because i know i checked first ship no ships already, and second ship agains 1 ship
					for(var j= (i+1); j<this.ships.length; j++){
						var secondShip = this.ships[j];
							if(firstShip.isEqualToShip(secondShip)){
								//console.log("pushing to remove")
								toRemove.push(secondShip);
							}
					}
				}
				//console.log("this many to remove: " + toRemove.length)
				for(var i = 0; i<toRemove.length; i++){
						removeFromArray(toRemove[i], this.ships)
				}

	}


	this.getGoodShips = function(){
		var ret = [];
		for(var i = 0; i<this.ships.length; i++){
			var ship = this.ships[i];
			if(ship.isGoodShip()){
				ret.push(ship);
			}
		}
		return ret;
	}

	this.printShips = function(ships){
		return(ships.map(function(e){
			return e.toString();
		}).join("\n<br>"));
	}

	this.printAllShips = function(){
		return this.printShips(this.ships);
	}





	this.content = function(){
		//console.log("Updating shipping grid in: " + this.session.session_id);
		removeFromArray(this.heartPlayer, this.session.availablePlayers);
		this.heartPlayer.increasePower();
		return "The " + this.heartPlayer.htmlTitleBasic() + " updates their shipping grid. <Br>" + this.savedShipText;
		//return "todo: update shipping grid for heart player.  updating it lowers the trigger level of all involved.  also, save clubs and diamonds to session. extract ships from it. if a player is in more than one diamonds, erase previous one.";

	}
}



//contains both relationship and it's inverse, knows how to render itself. dead players have a hussie style x over their faces.
//ships can also refuse to render themselves.  return false if that happens.
// render if: r2.saved_type == r2.goodBig || r2.saved_type == r2.badBig
function Ship(r1, r2){
		this.r1 = r1;
		this.r2 = r2;

		this.relationshipTypeToText = function(r){
		if(r.saved_type ==  r.heart){
			return "<font color = 'red'>&#x2665</font>"
		}

		if(r.saved_type ==  r.spades){
			return "<font color = 'black'>&#x2660</font>"
		}

		if(r.saved_type ==  r.clubs){
			return "<font color = 'grey'>&#x2663</font>"
		}

		if(r.saved_type ==  r.diamond){
			return "<font color = 'pink'>&#x2666</font>"
		}

		if(r.saved_type ==  r.neutral){
			return "<font color = 'black'>0_0</font>"
		}

		if(r.saved_type ==  r.goodBig){
			return "<font color = 'red'>&#x2661</font>"
		}

		if(r.saved_type ==  r.badBig){
			return "<font color = 'black'>&#x2664</font>"
		}

		if(r.saved_type ==  r.goodMild){
			return "<font color = 'black'>&#x263A</font>"
		}

		if(r.saved_type ==  r.badMild){
			return "<font color = 'black'>&#x2639</font>"
		}
		return r.saved_type;
	}

		//a relationship doesn't know who owns it, just what hte target is,so printing is funny
		this.toString = function(){
			return r2.target.htmlTitleBasic() + " " + this.relationshipTypeToText(r1) + "---" + this.relationshipTypeToText(r2) + " " + r1.target.htmlTitleBasic();
		}
		//order doesn't matter.
		this.isEqualToShip = function(ship){
			//console.log("comparing: " + this.toString() + " to "  + ship.toString())
			if(ship.r1 == this.r1 && ship.r2 == this.r2){
				//console.log("they are the same1")
				return true;
			}else if(ship.r2 == this.r1 && ship.r1 == this.r2){
				//console.log("they are the same2")
				return true;
			}
		//	console.log("they are not the same")
			return false;
		}

		//TODO, yellow yards with combo sessions and heart players will fail here. find out why.
		this.isGoodShip = function(){
			if(r2.saved_type == "" || r1.saved_type == "" ){
				return false;
			}

			if(r1.saved_type == r1.goodBig || r1.saved_type == r1.badBig || r1.saved_type == r1.heart || r1.saved_type == r1.diamond || r1.saved_type == r1.spades || r1.saved_type == r1.clubs){
				return true;
			}

			if(r2.saved_type == r2.goodBig || r2.saved_type == r1.badBig || r2.saved_type == r1.heart || r2.saved_type == r2.diamond || r2.saved_type == r2.spades || r2.saved_type == r2.clubs){
				return true;
			}
			return false;
		}

}
