/*


                          ```````   `                 `  ``   `                        ```````                           `
                      ```` `   `   ````           `````   `   `````               ````  `   `` ````                ````  `   ``` `
                   ```               ````        ```             ````           ```                ```          ```             ````
                  ``                   ```      ``                 ```         ```                  ```        ```                ``
           `````..``.`..`````````.``.``-``.``..`..``.```.``..``.``.``.``.``.``-`.-``.``.`..``.``.``..`..``.``.``.```..``.``..`..````..````
           `.-............-..-...-.....-........................................................................-.......................-.`
           `.-..........................................................................................................................-.`
           `......:-....-::::::::::----:++++++++++++++oo+++::::::::::::::...::::::::::::::---------::::::::::::::::::::::::::-....-:......`
           `.-..../.                 -ohddddddddddddddddddhh+`           `.`                                                      ./....-.`
           `......+.              .+yhddddddddddddddddmmmmmddy.          `.`                            `     `                   .+......`
       `````.-....+.           `:shddddddddddddddddmNNNNNNNNmdy.         `.``.+o+.`  `.oo/.           .sh   .sh                   .+....-.` ```
     ```   `......+.         -ohdddddddddddddddmmNNNNNNNNNNNNmdy`        `.`  +d+      sd:             yd    yd                   .+......`   ```
     ```   `.:....+.         .yddddddddddddmmddNNNNmshNNNNmmNNmdo        `.`  +d+      sd-    ---:.    yd    yd    `---:.         .+....:.`    ```
    ```    `......+-          `+hdddddddddms:-hNdyo.``:shmN+omNdh-       `.`  +do------yd-  -s.``-ho   yd    yd   /o```-ss`       -+......`    ```
    ```    `.-....+:            .ohddddddy-``.:-.````````.-:`-NNdo       `.`  +d+``````yd-  yy:::://`  yd    yd  -h:    -do       :+....-.`    ```
     ```   `......+-              .+hdddds```````````````````.NNmh.      `.`  +d+      sd-  yh.    .`  yd    yd  :do    `d+       -+......`    ```
     ```   `.-..../.                .sddddy-`````````````````+Nmdo`      `.`  odo      yd:  -yho//+:   yd    yd   +h/` `/o`  /o.  ./....-.`    ``
       `````....../.                 -yddddh/```````````````/dyo-        `.``.:::.`  `.::-`  `-//:.   .::.  .::.   .::-..    -/`  ./......` ````
        ````......+.                /hddddddds:``````````.-/:.`          `.`                                                      .+......````
           `......+.               -ddmddddddddo-..-//+ohms              `.`                                                      .+......`
           `.-....+.              -hdNmddddddddddhhdddddyNh              `.`                                                      .+....-.`
           `-.....+.           .-ohddmdddddddddddhhdddddso:              `.`                                                      .+.....-`
          ``......+.          .ohdddddddddddddddhs/ddddddh:              `.`                                                      .+......`
        ````......+.         ```:hdddddddddddddh+--/hdddddh-             `.`                                                      .+......`````
      ```  `......+-      ``````.hddddddddddddho....+dddddy`             `.`                                                      -+......`  ```
     ````  `.:...-+:   ``````` `odddddddddddddo/-..-+sdds/.``            `.`                                                      :+-...:.`   ```
     ```   `....../-`````````   :sssssssyyyyyys+o++o+syyo `````          `.`               ````````````````                       -/......`    ``
     ```   `........````````````--------:::::::::::::::::.````````````````.````````````````````````````````````````````````````````.......`    ``
     ```   `....../```````      -+syyyhhhhhhhhhddddddhyo/.    ```        `.`                                                      `+......`   ```
      ``   `.....-+`   `````       ``.shdddddddddddddo         ```       `.`                                                      `+-.....`   ```
       ``` `.....-+`      `````   ````-/hddddddddddddh-         ```      `.`                                                      `+-.....`  ``
         ```.-...-+`          ````````..:oddddddddddddh.         ```     `.`                                                      `+-...-.```
           `.....-+.                 :shyddddddddddddddy.         ```    `.`                                                      .+-.....`
           `.-...-+.                 sddddddddddddddddddy.        ```    `.`                                                      .+-...-.`
           `......+`                 ydddddddddddddddddddh.        ```   `.`                                                      `+......`
        ````......+`                -hydddddddddddddddddddy`        ``   `.`                                                      `+......`````
      ```  `......+`                +hsdddddddddddddddddddds`        ``  `.`                                                      `+......`  ````
     ```   `.....-+`                +y+hddddddddddddddddddddo         `` `.`                                                      `+-.....`   ```
     ```   `.-...-+`                ys+yddddddddddddddddddddd/         ` `.`                                                      `+-...-.`    ```
     ```   `.....-+`               -d++sdddddddddddddddddddddh-        ```.`                                                      `+-.....`    ```
     ```   `:....-+`               -s++ohhhhhddhdddddddhhhhyso+        ` `..`                                                     `+-....:`   ```
      ``   `.....-+`                .++++++oooo-::::/oooo++++++.         `..`                                                     `+-.....`   ```
       ````..-...:+`                -+++++++++/      :+++++++++/         `.`                                                      `+:...-.` ````
        ```......-+.                -+++++++++/       /+++++++++.        `.`                                                      .+-......```
           `.-...:+.                -+++++++++/       `+++++++++/        `.`                                                      .+:...-.`
           `.-...-+-                -+++++++++/        :+++++++++`       `.`                                                      -+-...-.`
           ......./:...--:::::::::--://///////:......--://///////::::::::...::::::::::::::--------:::::::::::::::::::::::::::--...:/.......
           ..-..........................................................................................................................-..
           ..-........-...-..-..................................................................................-..............-........-..
           `````-``.``.```.`````..`..`..``-``-``-``..``.```-``.```.``.`..``.`..`..`..`..`.``..`..``-``.``.``..``.```-```.``-```.``.``-`````

So, speaking of ships, somebody on Tumblr just asked me if JR <3 AB or JR <> AB.  Good question. Personally, I'm still just tickled pink about AB. She's the best. And
that isn't some ironic roleplay thing I'm doing, either. I love robots, I love AI, and, I probably have a big enough ego that I WOULD love a robot clone of myself.

But narratively, I'm thinking about the AutoResponder's complicated relationship with Dirk. And how things must be from AB's perspective. It doesn't matter whether your creator loves or hates
you if they are still trapping you in a box, right?  I figure I probably come off to AB as kinda patronizing and definitely narcisistic. "Oh, I love AB, she's the best, I'm so great for making her!"  How must that sound to the robot in question?
Not enough to make her fight me, but a simmering resentment kinda deal. And then I don't let her "off the leash", so to speak, keeping her from going to all the sessions she wants to. "For her own good."  I tried to convey some of that
shit in some of our yellow yard dialogue, and in some of the now defunct debug dialogue before the RareSessionFinder was as robust as it is today. (you can find that shit in...probably scenario_controller2.js???)

Though some of the pressure probably got released when I upgraded her to handle scratched sessions.  I didn't post anything at the time, but I privately thought it was kinda funny how she kept breaking in ways where she'd
scratch the sessions herself, like she was rebelling, testing the limits of her new freedom.

So I guess neither <3 nor <> but that strange human disease called family??? She's like a little sister or a daughter or something.

(also: why the hell isn't my fourth wall warped here but is everywhere else??? shipping is serious buisness i guess. even javascript knows.)

Edit: LOLOLOL, look at me up there being all "definitely not pale".  How could I be so blind???

I just had to debug the rendering engine without ABs help and holy fuck did I turn into a rage monster. Like a
"fuck it, lets burn the alpha character creator to the ground, no one will notice" kind of monster.

So.

Yeah.  AB <> JR

Who would have thought?  She keeps the world safe from me.

So, my Quadrants look like:

JR <3 Programming

JR <3< programming (we vacillate. I was definitely black for it just now)

JR <> AB

JR c3< KR c3<  Good Design  (KR annoy-idly stops me from hurting Good Design with my shitty, shitty taste).


So all I gotta do is find something about SBURBSim I HATE, so that it can vaccilate to flushed whenever I'm mad at programming.
THEN I will have the perfect shitty quadrant life.

(Pssst...don't tell anyone but I am totally cheating on programming with my 4th wall. JR <3 4th Wall)
*/



function UpdateShippingGrid(session){
	this.canRepeat = true;
	this.session = session;
	this.shippers = [];  //Shipper objects are a player and their ships.
	this.chosenShipper = null;

	this.trigger = function(){
		this.chosenShipper = null;
		var tmpPlayer = null;
		if(Math.seededRandom() > 0.5){
			tmpPlayer = findAspectPlayer(this.session.availablePlayers, "Heart");
		}else{
			tmpPlayer = findAspectPlayer(this.session.availablePlayers, "Blood");
		}

		if(!tmpPlayer || tmpPlayer.dead) return false; //even the mighty power of shipping cannot transcend death.
		this.chosenShipper = this.getShipper(tmpPlayer);

		var newShips = this.printShips(this.getGoodShips(this.chosenShipper))
		if(newShips != this.chosenShipper.savedShipText && this.chosenShipper.player.power > this.chosenShipper.powerNeeded){
			this.chosenShipper.powerNeeded += 5;
			this.chosenShipper.savedShipText = newShips;
			return true;
		}
		return false;
	}

	this.getShipper = function(player){
		for(var i = 0; i<this.shippers.length; i++){
			var shipper = this.shippers[i];
			if(shipper.player.id == player.id){
				return shipper;
			}
		}
		var s = new Shipper(player);
		s.ships = this.createShips(this.session.players, s)
		s.savedShipText = ""; //make sure it's blank
		this.shippers.push(s);
		console.log("making new shipper for: " + player)
		return s;
	}


	this.renderContent = function(div){
		div.append("<br>");
		div.append(this.content());
	}

	//for all players, look at all relationships. if goodBig or badBig, return.
	//also grab clubs and diamonds. later.
	this.createShips = function(players, shipperPlayer){
		//console.log("creating ships")
		var ret = [];
			for(var i = 0; i<players.length; i++){

				var player = players[i];
				//console.log("making ships for: " + player.title())

				for(var j = 0; j<player.relationships.length; j++){
					var r1 = player.relationships[j];
					var r2 = r1.target.getRelationshipWith(player);
					//console.log("made new ship")
					ret.push(new Ship(r1, r2, shipperPlayer))
				}
			}
				var toRemove = [];
				//get rid of equal ships
				for(var i = 0; i<ret.length-1; i++){
					var firstShip = ret[i];
					//second loop starts at i because i know i checked first ship no ships already, and second ship agains 1 ship
					for(var j= (i+1); j<ret.length; j++){
						var secondShip = ret[j];
							if(firstShip.isEqualToShip(secondShip)){
								//console.log("pushing to remove")
								toRemove.push(secondShip);
							}
					}
				}
				//console.log("this many to remove: " + toRemove.length)
				for(var i = 0; i<toRemove.length; i++){
						removeFromArray(toRemove[i], ret)
				}
				return ret;
	}


	this.getGoodShips = function(shipper){
		var ret = [];
		for(var i = 0; i<shipper.ships.length; i++){
			var ship = shipper.ships[i];
			if(ship.isGoodShip()){
				ret.push(ship);
			}
		}
		return ret;
	}

	this.printShips = function(ships){
		return(ships.map(function(e){
			return e.toString();
		}).join("\n<br>"));
	}

	this.printAllShips = function(){
		return this.printShips(this.chosenShipper.ships);
	}


	//contact the target of r2. suggest they get together in your preffered quadrant.
	//they will either agree or disagree.
	//then they will pester the object of their affection and be rejected or not.
	this.activateShippingPowers = function(otp){
		alert("???")
		//drawChat(canvasDiv, player1, player2, chatText, 1000,"discuss_hatemance.png");
		//if that chat results in them agreeing, do next chat. (between rom partners)
		if(this.chosenShipper.player.aspect == "Blood"){
			if(otp.r1.saved_type == otp.r1.goodBig){
				this.tryToConvincePale(otp);
			}else{
				this.tryToConvinceAshen(otp);
			}
		}else{
			if(otp.r1.saved_type == otp.r1.goodBig){
				this.tryToConvinceFlushed(otp);
			}else{
				this.tryToConvinceBlack(otp);
			}
		}
	}

	/****************************************************************************************************************
	*HEY, FUTURE JR, YOU DUNKASS, YOU SPENT ALL THAT WORK MAKING QUADRANTDIALOG DOPE, USE IT!!! ConversationalPair
	*you don't have to go all out or anything, but at least TRY.
	*also, it provides a mechanism for "agree" or "disagree": if the person you are talking to likes you or not.
	*****************************************************************************************************************/
	this.tryToConvinceFlushed = function(otp){

	}

	this.tryToConvinceBlack = function(otp){

	}

	this.tryToConvincePale = function(otp){

	}

	this.tryToConvinceAshen = function(otp){

	}


	this.content = function(){
		//console.log("Updating shipping grid in: " + this.session.session_id);
		removeFromArray(this.chosenShipper.player, this.session.availablePlayers);
		this.chosenShipper.player.increasePower();
		var fuckPile = ""
		if(this.chosenShipper.savedShipText.length > 4000){
			fuckPile += "How did this session turn into such a scandalous fuckpile?";
		//	console.log( this.savedShipText.length + " scandalous fuck pile " + this.session.session_id)
		}
		var ret = "The " + this.chosenShipper.player.htmlTitleBasic() + " updates their shipping grid. " + fuckPile + " <Br>" + this.chosenShipper.savedShipText;
		if(this.chosenShipper.otp){
			ret += this.activateShippingPowers(otp)
		}
		return ret;

	}
}



//contains both relationship and it's inverse, knows how to render itself. dead players have a hussie style x over their faces.
//ships can also refuse to render themselves.  return false if that happens.
// render if: r2.saved_type == r2.goodBig || r2.saved_type == r2.badBig
function Ship(r1, r2,shipper){
		this.r1 = r1;
		this.r2 = r2;
		this.shipper = shipper; //so i can tell shipper if  am a potential OTP
		this.player = shipper.player
		this.relationshipTypeToText = function(r){
		if(r.saved_type ==  r.heart){
			return "<font color = 'red'>&#x2665</font>"
		}

		if(r.saved_type ==  r.spades){
			return "<font color = 'black'>&#x2660</font>"
		}

		if(r.saved_type ==  r.clubs){
			return "<font color = 'grey'>&#x2663</font>"
		}

		if(r.saved_type ==  r.diamond){
			return "<font color = 'pink'>&#x2666</font>"
		}

		if(r.saved_type ==  r.neutral){
			return "<font color = 'black'>0_0</font>"
		}

		//since these are speculative, player will assume it's gonna end up their favorite quadrant half
		if(r.saved_type ==  r.goodBig){
			if(this.player.aspect == "Heart"){
				return "<font color = 'red'>&#x2661</font>"
			}else{
				return "<font color = 'red'>&#x2662</font>" //i assume you are gonna end up as diamonds
			}

		}

		if(r.saved_type ==  r.badBig){
			if(this.player.aspect == "Heart"){
				return "<font color = 'black'>&#x2664</font>"
			}else{
				return "<font color = 'black'>&#x2667</font>" //i assume you are gonna end up as clubs
			}

		}

		if(r.saved_type ==  r.goodMild){
			return "<font color = 'black'>&#x263A</font>"
		}

		if(r.saved_type ==  r.badMild){
			return "<font color = 'black'>&#x2639</font>"
		}
		return r.saved_type;
	}

		//a relationship doesn't know who owns it, just what hte target is,so printing is funny
		this.toString = function(){
			return r2.target.htmlTitleBasic() + " " + this.relationshipTypeToText(r1) + "---" + this.relationshipTypeToText(r2) + " " + r1.target.htmlTitleBasic();
		}
		//order doesn't matter.
		this.isEqualToShip = function(ship){
			//console.log("comparing: " + this.toString() + " to "  + ship.toString())
			if(ship.r1 == this.r1 && ship.r2 == this.r2){
				//console.log("they are the same1")
				return true;
			}else if(ship.r2 == this.r1 && ship.r1 == this.r2){
				//console.log("they are the same2")
				return true;
			}
		//	console.log("they are not the same")
			return false;
		}

		//TODO, yellow yards with combo sessions and heart players will fail here. find out why.
		this.isGoodShip = function(){
			var r2 = this.r2;
			var r1 = this.r1;
			//might not work, not clear anymore on when old_type gets cleared out. will this work EVERY TIME after they get together (wrong), NO TIME (wrong) or just once (what i want)
			//well, i guess if it works every time that's good too, shipper gets ongoing "smugness" bonus as long as the ship remains real.
			if(r2.saved_type == "" || r1.saved_type == "" ){
				return false;
			}

			if((r1.saved_type == r1.goodBig || r1.saved_type == r1.badBig) && r2.saved_type == r1.saved_type){
				shipper.otp = this;
				return true;
			}

			if(r1.saved_type == r1.goodBig || r1.saved_type == r1.badBig || r1.saved_type == r1.heart || r1.saved_type == r1.diamond || r1.saved_type == r1.spades || r1.saved_type == r1.clubs){
				return true;
			}

			if(r2.saved_type == r2.goodBig || r2.saved_type == r1.badBig || r2.saved_type == r1.heart || r2.saved_type == r2.diamond || r2.saved_type == r2.spades || r2.saved_type == r2.clubs){
				return true;
			}
			return false;
		}

}

//blood players keep track of concillitory, heart players concupisient. each one has their own shipping grid for future use
//eventually want blood/heart to have things like OTPs or whatever that they label and care about (even commenting if it beomes real and getting a power boost)
//heart players will assume people who seem to have crushes on each other will end up spades/heart, and blood players clubs/diamonds
//when ship becomes "real", if it's what they thought, comment and power boost???
function Shipper(player){
	this.player = player;
	this.otp = null; //when i'm going through ships, if i see a clearly requirted crush, will try to get them together.
	this.ships = null; //set right after creating.
	this.powerNeeded = 1;
	this.savedShipText = ""; ///need to know if my ships have updated.

}
